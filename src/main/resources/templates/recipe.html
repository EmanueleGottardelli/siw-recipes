<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SiwRecipes - Dettagli ricetta</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

	<div th:replace="fragments/navbar :: navbar"></div>

	<div class="container my-5">
		<div class="row">

			<!-- Details -->
			<div class="col-md-8">
				<h1 class="mb-3" th:text="${recipe.title}">Titolo della ricetta</h1>
				<p class="text-muted">
					<strong>Autore:</strong>
					<span th:text="${recipe.author.credentials.username}">Username dell'autore</span>
				</p>
				<p>
					<strong>Descrizione:</strong>
					<span th:text="${recipe.description}"></span>
				</p>
				<p>
					<strong>Categoria:</strong> <span th:text="${recipe.category}">Dolci...</span><br>
					<strong>Difficoltà:</strong> <span th:text="${recipe.difficulty}">3</span>/5<br>
					<strong>Tempo di preparazione:</strong>
					<span th:text="${recipe.prepTime}"></span> min
				</p>
				<p th:text="${recipe.procedimento}">
					Recipe procedimento
				</p>

				<div th:if="globalUser != null and (recipe.author.id == globalUser.id)">
					<a th:href="@{/recipe/{id}/edit(id=${recipe.id})}" class="btn btn-primary btn-sm  me-2">Aggiorna ricetta</a>
				</div>

				<hr class="my-4">

				<h3>Ingredienti</h3>

				<!-- Tabella ingredienti -->
				<div th:if="${#lists.isEmpty(recipe.ingredients)}" class="alert alert-info">
					Nessun ingrediente inserito.
				</div>

				<table th:if="${!#lists.isEmpty(recipe.ingredients)}" class="table table-sm table-striped align-middle">

					<thead class="table-light">
						<tr>
							<th>Nome</th>
							<th>Quantità</th>
							<th>Unità</th>
							<th></th>
						</tr>
					</thead>

					<tbody>
						<tr th:each="ing : ${recipe.ingredients}">
							<td th:text="${ing.name}"></td>
							<td th:text="${ing.quantity}"></td>
							<td th:text="${ing.unitMeasurement}"></td>

							<td class="text-end">

								<!-- elimina solo autore o admin -->
								<form
									th:if="${globalUser != null and (recipe.author.id == globalUser.id or globalUser.isAdmin())}"
									th:action="@{/recipe/{recipeId}/ingredients/{ingId}/delete(
				                                recipeId=${recipe.id},
				                                ingId=${ing.id})}" method="post" style="display:inline">

									<button class="btn btn-danger btn-sm">Elimina</button>
								</form>

							</td>
						</tr>
					</tbody>
				</table>

				<div th:if="${globalUser != null and (recipe.author.id == globalUser.id or globalUser.isAdmin())}"
					class="card mt-3 p-3 shadow-sm">

					<h5>Aggiungi ingrediente</h5>

					<form th:action="@{/recipe/{id}/ingredients/add(id=${recipe.id})}" method="post">

						<div class="row g-2">

							<div class="col-md-4">
								<input name="name" class="form-control" placeholder="Nome" required>
							</div>

							<div class="col-md-3">
								<input name="quantity" type="number" step="0.1" class="form-control"
									placeholder="Quantità" required>
							</div>

							<div class="col-md-3">
								<input name="unitMeasurement" class="form-control" placeholder="Unità (g, ml...)"
									required>
							</div>

							<div class="col-md-2">
								<button class="btn btn-success w-100">Aggiungi</button>
							</div>

						</div>
					</form>
				</div>


				<!-- Button back -->
				<a th:href="@{/recipe}" class="btn btn-primary mt-3">Torna al catalogo</a>
			</div>
		</div>

		<!-- Reviews -->
		<div th:each="review : ${recipe.reviews}" class="card mb-3">
			<div class="card-body">
				<h5 class="card-title">
					<span th:text="${review.author.credentials.username}">Author</span>
				</h5>
				<p class="card-text" th:text="${review.text}">Review text...</p>
				<p class="fw-bold">Voto: <span th:text="${review.evaluation}">1</span>/5</p>

				<div class="mt-3">
					<!-- Solo l'autore può modificare -->
					<a th:if="${globalUser != null and review.author.id == globalUser.id}"
						th:href="@{/review/{id}/edit(id=${review.id})}" class="btn btn-sm btn-warning me-2">Modifica</a>
				</div>
				<div class="mt-3">
					<!-- L'autore o admin possono eliminare -->
					<form th:if="${gloabalUser != null and (review.author.id == globalUser.id or globalUser.isAdmin())}"
						th:action="@{/review/{id}/delete(id=${review.id})}" method="post" style="display:inline">
						<button type="submit" class="btn btn-sm btn-danger">Elimina</button>
					</form>
				</div>
			</div>
		</div>

		<div th:if="${globalUser == null}" class="alert alert-warning text-center">
			Fai il login per lasciare una recensione!
		</div>


		<div class="container my-5" th:if="${globalUser != null}">
			<h2 class="mb-4">Lascia una recensione</h2>

			<form th:action="@{/recipe/{recipeId}/review(recipeId=${recipe.id})}" th:object="${newReview}"
				method="post">

				<div class="mb-3">
					<label for="text" class="form-label">Recensione</label>
					<textarea id="text" class="form-control" th:field="*{text}"></textarea>
				</div>

				<div class="mb-3">
					<label for="rating" class="form-label">Voto (1–5)</label>
					<input type="number" id="rating" class="form-control" th:field="*{evaluation}" min="1" max="5">
				</div>

				<button type="submit" class="btn btn-primary">Invia Recensione</button>
			</form>
		</div>

	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>